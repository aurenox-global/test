<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Declaraci√≥n de la Renta - Herramienta Avanzada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 2rem;
        }

        .nav-tab {
            padding: 12px 20px;
            border: none;
            border-radius: 50px;
            background: #ecf0f1;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ecf0f1;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .summary-card h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .summary-card .amount {
            font-size: 2rem;
            font-weight: 700;
        }

        .info-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
        }

        .info-card h4 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .info-card p {
            color: #7f8c8d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            margin-top: 0.5rem;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            margin-top: 0.5rem;
        }

        .progress-bar {
            background: #ecf0f1;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }

        .deductions-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .deduction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .alert {
            background: #e8f5e8;
            color: #27ae60;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #27ae60;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .savings-section {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 1rem;
        }

        .validation-error {
            border-color: #e74c3c !important;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1) !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                justify-content: center;
            }

            .nav-tab {
                font-size: 0.8rem;
                padding: 10px 16px;
            }

            .container {
                padding: 15px;
            }

            .sidebar {
                position: static;
                order: -1;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 1.5rem;
            }

            .form-section,
            .sidebar {
                padding: 1.5rem;
            }

            .summary-card .amount {
                font-size: 1.5rem;
            }
        }

        .tax-brackets {
            font-size: 0.8rem;
            margin-top: 1rem;
        }

        .tax-bracket {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            margin: 1rem 0;
        }

        .optimization-tips {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
        }

        /* Estilos para el modal del simulador */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 1000px;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
        }

        .simulation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .scenario-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .scenario-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .difference-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
        }

        .detail-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .recommendations-section {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #27ae60;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .simulation-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h1 id="mainTitle">üá™üá∏ Declaraci√≥n de la Renta </h1>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="exerciseYear" style="font-weight: 600; color: #2c3e50;">Ejercicio:</label>
                    <select id="exerciseYear" onchange="changeYear()" style="padding: 8px 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-weight: 600; background: white;">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                    </select>
                </div>
            </div>
            <p id="headerDescription">Herramienta avanzada para el c√°lculo de IRPF - Totalmente offline con PDFs reales</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="form-section">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('personal')">üë§ Personal</button>
                    <button class="nav-tab" onclick="showTab('ingresos')">üí∞ Ingresos</button>
                    <button class="nav-tab" onclick="showTab('deducciones')">üìâ Deducciones</button>
                    <button class="nav-tab" onclick="showTab('optimizacion')">‚ö° Optimizaci√≥n</button>
                    <button class="nav-tab" onclick="showTab('resultado')">üìä Resultado</button>
                </div>

                <div id="personal" class="tab-content active">
                    <h2>Datos Personales</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nif">NIF/NIE</label>
                            <input type="text" id="nif" placeholder="12345678A" maxlength="9" onchange="validateNIF()">
                        </div>
                        <div class="form-group">
                            <label for="nombre">Nombre completo</label>
                            <input type="text" id="nombre" placeholder="Nombre y apellidos">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edad">Edad</label>
                            <input type="number" id="edad" min="16" max="100" value="35" onchange="calculate()">
                        </div>
                        <div class="form-group">
                            <label for="estadoCivil">Estado Civil</label>
                            <select id="estadoCivil" onchange="calculate()">
                                <option value="soltero">Soltero/a</option>
                                <option value="casado">Casado/a</option>
                                <option value="divorciado">Divorciado/a</option>
                                <option value="viudo">Viudo/a</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hijos">N√∫mero de hijos</label>
                            <input type="number" id="hijos" min="0" max="10" value="0" onchange="calculate()">
                        </div>
                        <div class="form-group">
                            <label for="discapacidad">Grado de discapacidad (%)</label>
                            <input type="number" id="discapacidad" min="0" max="100" value="0" onchange="calculate()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="comunidad">Comunidad Aut√≥noma</label>
                        <select id="comunidad" onchange="calculate()">
                            <option value="madrid">Madrid</option>
                            <option value="cataluna">Catalu√±a</option>
                            <option value="andalucia">Andaluc√≠a</option>
                            <option value="valencia">Valencia</option>
                            <option value="galicia">Galicia</option>
                            <option value="paisvasco">Pa√≠s Vasco</option>
                            <option value="castillaleon">Castilla y Le√≥n</option>
                            <option value="aragon">Arag√≥n</option>
                            <option value="asturias">Asturias</option>
                            <option value="baleares">Baleares</option>
                            <option value="canarias">Canarias</option>
                            <option value="cantabria">Cantabria</option>
                            <option value="castillalamancha">Castilla-La Mancha</option>
                            <option value="extremadura">Extremadura</option>
                            <option value="larioja">La Rioja</option>
                            <option value="murcia">Murcia</option>
                            <option value="navarra">Navarra</option>
                        </select>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="mayor65" onchange="calculate()">
                        <label for="mayor65">Mayor de 65 a√±os</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="mayor75" onchange="calculate()">
                        <label for="mayor75">Mayor de 75 a√±os</label>
                    </div>
                </div>

                <div id="ingresos" class="tab-content">
                    <h2 id="ingresosTitle">Ingresos del Ejercicio 2024</h2>
                    <div class="form-group">
                        <label for="sueldos">Rendimientos del trabajo (‚Ç¨)</label>
                        <input type="number" id="sueldos" step="0.01" value="35000" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label for="pensiones">Pensiones p√∫blicas (‚Ç¨)</label>
                        <input type="number" id="pensiones" step="0.01" value="0" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label for="pensionesPrivadas">Pensiones privadas (‚Ç¨)</label>
                        <input type="number" id="pensionesPrivadas" step="0.01" value="0" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label for="alquiler">Rendimientos inmobiliarios (‚Ç¨)</label>
                        <input type="number" id="alquiler" step="0.01" value="0" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label for="capital">Dividendos y rendimientos financieros (‚Ç¨)</label>
                        <input type="number" id="capital" step="0.01" value="0" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label for="intereses">Intereses de cuentas bancarias (‚Ç¨)</label>
                        <input type="number" id="intereses" step="0.01" value="0" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label for="actividades">Rendimientos de actividades econ√≥micas (‚Ç¨)</label>
                        <input type="number" id="actividades" step="0.01" value="0" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label for="ganancias">Ganancias y p√©rdidas patrimoniales (‚Ç¨)</label>
                        <input type="number" id="ganancias" step="0.01" value="0" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label for="subvenciones">Subvenciones p√∫blicas (‚Ç¨)</label>
                        <input type="number" id="subvenciones" step="0.01" value="0" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label for="retenido">IRPF retenido/ingresado a cuenta (‚Ç¨)</label>
                        <input type="number" id="retenido" step="0.01" value="5250" onchange="calculate()">
                    </div>
                </div>

                <div id="deducciones" class="tab-content">
                    <h2>Deducciones y Reducciones</h2>
                    
                    <h3>üí∞ Reducciones (reducen la base imponible)</h3>
                    <div class="form-group">
                        <label for="planPensiones">Aportaciones a plan de pensiones (‚Ç¨)</label>
                        <input type="number" id="planPensiones" step="0.01" value="0" max="1500" onchange="calculate()">
                        <small style="color: #7f8c8d;">M√°ximo 1.500‚Ç¨ anuales</small>
                    </div>
                    <div class="form-group">
                        <label for="mutualidad">Aportaciones a mutualidades (‚Ç¨)</label>
                        <input type="number" id="mutualidad" step="0.01" value="0" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label for="pias">Planes individuales de ahorro sistem√°tico (‚Ç¨)</label>
                        <input type="number" id="pias" step="0.01" value="0" max="5000" onchange="calculate()">
                    </div>

                    <h3>üè† Deducciones estatales</h3>
                    <div class="form-group">
                        <label for="vivienda">Deducci√≥n por vivienda habitual (‚Ç¨)</label>
                        <input type="number" id="vivienda" step="0.01" value="0" onchange="calculate()">
                        <small style="color: #7f8c8d;">Solo para compras anteriores a 2013</small>
                    </div>
                    <div class="form-group">
                        <label for="donativos">Donativos a ONG (‚Ç¨)</label>
                        <input type="number" id="donativos" step="0.01" value="0" onchange="calculate()">
                        <small style="color: #7f8c8d;">75% los primeros 150‚Ç¨, 30% el resto</small>
                    </div>
                    <div class="form-group">
                        <label for="partidosPoliticos">Cuotas a partidos pol√≠ticos (‚Ç¨)</label>
                        <input type="number" id="partidosPoliticos" step="0.01" value="0" onchange="calculate()">
                    </div>

                    <h3>üè• Deducciones auton√≥micas comunes</h3>
                    <div class="form-group">
                        <label for="guarderia">Gastos de guarder√≠a (‚Ç¨)</label>
                        <input type="number" id="guarderia" step="0.01" value="0" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label for="textosEscolares">Libros de texto (‚Ç¨)</label>
                        <input type="number" id="textosEscolares" step="0.01" value="0" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label for="seguroMedico">Seguro m√©dico privado (‚Ç¨)</label>
                        <input type="number" id="seguroMedico" step="0.01" value="0" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label for="rehabilitacion">Obras de rehabilitaci√≥n vivienda (‚Ç¨)</label>
                        <input type="number" id="rehabilitacion" step="0.01" value="0" onchange="calculate()">
                    </div>

                    <div class="deductions-list">
                        <h3>üìã Reducciones autom√°ticas aplicadas:</h3>
                        <div class="deduction-item">
                            <span>M√≠nimo personal</span>
                            <span id="minimoPersonal">5.550 ‚Ç¨</span>
                        </div>
                        <div class="deduction-item">
                            <span>M√≠nimo por descendientes</span>
                            <span id="minimoDescendientes">0 ‚Ç¨</span>
                        </div>
                        <div class="deduction-item">
                            <span>Gastos deducibles del trabajo</span>
                            <span id="gastosDeducibles">2.000 ‚Ç¨</span>
                        </div>
                        <div class="deduction-item">
                            <span>Reducci√≥n por edad (>65 a√±os)</span>
                            <span id="reduccionEdad">0 ‚Ç¨</span>
                        </div>
                    </div>
                </div>

                <div id="optimizacion" class="tab-content">
                    <h2>‚ö° Optimizaci√≥n Fiscal</h2>
                    
                    <div id="optimizationResults"></div>
                    
                    <div class="savings-section">
                        <h3>üí° Recomendaciones Autom√°ticas</h3>
                        <div id="recommendations"></div>
                    </div>
                    
                    <div class="optimization-tips">
                        <h4>üìà Simulador de Escenarios</h4>
                        <p>Prueba diferentes valores para optimizar tu declaraci√≥n:</p>
                        <button class="btn btn-secondary" onclick="simularEscenarios()">üéØ Simular Optimizaciones</button>
                    </div>
                </div>

                <div id="resultado" class="tab-content">
                    <h2>üìä Resultado Final</h2>
                    <div class="alert" id="resultadoAlert">
                        Completa todos los datos para ver el resultado final
                    </div>
                    
                    <div class="info-card">
                        <h4>üìä Base imponible general</h4>
                        <p>Total de ingresos menos gastos deducibles: <strong id="baseImponible">‚Ç¨</strong></p>
                    </div>
                    
                    <div class="info-card">
                        <h4>üìä Base liquidable general</h4>
                        <p>Base imponible menos reducciones: <strong id="baseLiquidable">‚Ç¨</strong></p>
                    </div>
                    
                    <div class="info-card">
                        <h4>üí∞ Cuota √≠ntegra estatal</h4>
                        <p>Impuesto estatal seg√∫n tramos: <strong id="cuotaIntegra">‚Ç¨</strong></p>
                    </div>

                    <div class="info-card">
                        <h4>üèõÔ∏è Cuota √≠ntegra auton√≥mica</h4>
                        <p>Impuesto auton√≥mico seg√∫n tramos: <strong id="cuotaAutonomica">‚Ç¨</strong></p>
                    </div>
                    
                    <div class="info-card">
                        <h4>‚úÖ Cuota l√≠quida total</h4>
                        <p>Cuota total menos deducciones: <strong id="cuotaLiquida">‚Ç¨</strong></p>
                    </div>

                    <div class="loading" id="loadingPDF">Generando PDF...</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <button class="btn" onclick="generarInforme()">üìÑ Generar PDF Completo</button>
                        <button class="btn btn-secondary" onclick="guardarDatos()">üíæ Guardar Borrador</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <button class="btn btn-warning" onclick="cargarDatos()">üìÇ Cargar Borrador</button>
                        <button class="btn btn-secondary" onclick="exportarExcel()">üìä Exportar Excel</button>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="summary-card">
                    <h3>Resultado Final</h3>
                    <div class="amount" id="resultadoFinal">0 ‚Ç¨</div>
                    <p id="resultadoTipo">A ingresar/A devolver</p>
                </div>

                <div class="summary-card" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">
                    <h3>Total Ingresos</h3>
                    <div class="amount" id="totalIngresos">35.000 ‚Ç¨</div>
                </div>

                <div class="summary-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    <h3>IRPF Total</h3>
                    <div class="amount" id="irpfCalculado">0 ‚Ç¨</div>
                    <div class="tax-brackets" id="taxBrackets"></div>
                </div>

                <div class="summary-card" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                    <h3>Ahorro Potencial</h3>
                    <div class="amount" id="ahorroTotal">0 ‚Ç¨</div>
                    <p>Con optimizaciones</p>
                </div>

                <div class="info-card">
                    <h4>üí° Consejos Fiscales</h4>
                    <p id="consejosFiscales">Revisa todas las deducciones disponibles para optimizar tu declaraci√≥n.</p>
                </div>

                <div class="info-card">
                    <h4>üìÖ Fechas Importantes 2025</h4>
                    <p><strong>Inicio campa√±a:</strong> 3 de abril<br>
                    <strong>Fin campa√±a:</strong> 1 de julio<br>
                    <strong>Cita previa:</strong> 2 de mayo<br>
                    <strong>L√≠mite domiciliaci√≥n:</strong> 25 de junio</p>
                </div>

                <div class="info-card">
                    <h4>‚öñÔ∏è Base Legal</h4>
                    <p id="legalBase">C√°lculos seg√∫n Ley 35/2006 del IRPF, RD 439/2007 y normativa auton√≥mica vigente.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal del Simulador -->
    <div id="simulationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; color: #2c3e50;">üéØ Simulador de Optimizaciones</h2>
                <button onclick="closeSimulationModal()" class="close-btn">√ó</button>
            </div>
            
            <div class="simulation-grid">
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìä Par√°metros de Simulaci√≥n</h3>
                    
                    <div class="form-group">
                        <label for="simSueldo">Rendimientos del trabajo (‚Ç¨)</label>
                        <input type="number" id="simSueldo" step="1000" onchange="updateSimulationResults()" style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px;">
                        <input type="range" id="simSueldoRange" min="15000" max="100000" step="1000" onchange="syncSlider('simSueldo', this.value); updateSimulationResults()" style="width: 100%; margin-top: 5px;">
                    </div>
                    
                    <div class="form-group">
                        <label for="simPlanPensiones">Plan de pensiones (‚Ç¨) - M√°x: 1.500‚Ç¨</label>
                        <input type="number" id="simPlanPensiones" max="1500" step="100" onchange="updateSimulationResults()" style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px;">
                        <input type="range" id="simPlanPensionesRange" min="0" max="1500" step="100" onchange="syncSlider('simPlanPensiones', this.value); updateSimulationResults()" style="width: 100%; margin-top: 5px;">
                    </div>
                    
                    <div class="form-group">
                        <label for="simDonativos">Donativos ONG (‚Ç¨)</label>
                        <input type="number" id="simDonativos" step="50" onchange="updateSimulationResults()" style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px;">
                        <input type="range" id="simDonativosRange" min="0" max="1000" step="50" onchange="syncSlider('simDonativos', this.value); updateSimulationResults()" style="width: 100%; margin-top: 5px;">
                    </div>
                    
                    <div class="form-group">
                        <label for="simGuarderia">Gastos guarder√≠a (‚Ç¨)</label>
                        <input type="number" id="simGuarderia" step="100" onchange="updateSimulationResults()" style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px;">
                        <input type="range" id="simGuarderiaRange" min="0" max="5000" step="100" onchange="syncSlider('simGuarderia', this.value); updateSimulationResults()" style="width: 100%; margin-top: 5px;">
                    </div>
                    
                    <div class="form-group">
                        <label for="simSeguroMedico">Seguro m√©dico (‚Ç¨)</label>
                        <input type="number" id="simSeguroMedico" step="100" onchange="updateSimulationResults()" style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px;">
                        <input type="range" id="simSeguroMedicoRange" min="0" max="3000" step="100" onchange="syncSlider('simSeguroMedico', this.value); updateSimulationResults()" style="width: 100%; margin-top: 5px;">
                    </div>
                    
                    <div class="form-group">
                        <label for="simComunidad">Comunidad Aut√≥noma</label>
                        <select id="simComunidad" onchange="updateSimulationResults()" style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px;">
                            <option value="madrid">Madrid</option>
                            <option value="cataluna">Catalu√±a</option>
                            <option value="andalucia">Andaluc√≠a</option>
                            <option value="valencia">Valencia</option>
                            <option value="galicia">Galicia</option>
                            <option value="paisvasco">Pa√≠s Vasco</option>
                            <option value="castillaleon">Castilla y Le√≥n</option>
                            <option value="aragon">Arag√≥n</option>
                            <option value="asturias">Asturias</option>
                            <option value="baleares">Baleares</option>
                            <option value="canarias">Canarias</option>
                            <option value="cantabria">Cantabria</option>
                            <option value="castillalamancha">Castilla-La Mancha</option>
                            <option value="extremadura">Extremadura</option>
                            <option value="larioja">La Rioja</option>
                            <option value="murcia">Murcia</option>
                            <option value="navarra">Navarra</option>
                        </select>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button onclick="aplicarOptimizaciones()" class="btn" style="margin-bottom: 10px;">‚úÖ Aplicar Optimizaciones</button>
                        <button onclick="resetearSimulacion()" class="btn btn-warning" style="margin-bottom: 10px;">üîÑ Resetear Valores</button>
                    </div>
                </div>
                
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìà Comparativa de Resultados</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                        <div class="scenario-card">
                            <h4 style="margin: 0 0 10px 0; color: #7f8c8d;">Escenario Actual</h4>
                            <div class="scenario-value" style="color: #e74c3c;" id="resultadoActualSim">0 ‚Ç¨</div>
                            <div style="font-size: 0.9rem; color: #7f8c8d;" id="tipoActualSim">A ingresar</div>
                        </div>
                        <div class="scenario-card">
                            <h4 style="margin: 0 0 10px 0; color: #7f8c8d;">Escenario Simulado</h4>
                            <div class="scenario-value" style="color: #27ae60;" id="resultadoSimulado">0 ‚Ç¨</div>
                            <div style="font-size: 0.9rem; color: #7f8c8d;" id="tipoSimulado">A ingresar</div>
                        </div>
                    </div>
                    
                    <div class="difference-card">
                        <h4 style="margin: 0 0 10px 0;">üí∞ Diferencia</h4>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="diferenciaSim">0 ‚Ç¨</div>
                        <div style="font-size: 0.9rem;" id="tipoDiferencia">Ahorro</div>
                    </div>
                    
                    <div class="detail-section">
                        <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üìä Detalle de Cambios</h4>
                        <div id="cambiosDetallados"></div>
                    </div>
                    
                    <div class="recommendations-section">
                        <h4 style="margin: 0 0 10px 0; color: #27ae60;">üí° Recomendaciones Autom√°ticas</h4>
                        <div id="recomendacionesSimulacion"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Datos tributarios oficiales Espa√±a 2024
        const tramosIRPFEstatal = [
            { desde: 0, hasta: 12450, tipo: 9.5 },
            { desde: 12450, hasta: 20200, tipo: 12 },
            { desde: 20200, hasta: 35200, tipo: 15 },
            { desde: 35200, hasta: 60000, tipo: 18.5 },
            { desde: 60000, hasta: 300000, tipo: 22.5 },
            { desde: 300000, hasta: Infinity, tipo: 24.5 }
        ];

        const tramosIRPFAutonomico = {
            madrid: [
                { desde: 0, hasta: 12450, tipo: 9.5 },
                { desde: 12450, hasta: 20200, tipo: 12 },
                { desde: 20200, hasta: 35200, tipo: 15 },
                { desde: 35200, hasta: 60000, tipo: 18.5 },
                { desde: 60000, hasta: 300000, tipo: 22.5 },
                { desde: 300000, hasta: Infinity, tipo: 22.5 }
            ],
            cataluna: [
                { desde: 0, hasta: 12450, tipo: 10.5 },
                { desde: 12450, hasta: 20200, tipo: 12 },
                { desde: 20200, hasta: 35200, tipo: 15 },
                { desde: 35200, hasta: 60000, tipo: 18.5 },
                { desde: 60000, hasta: 90000, tipo: 21.5 },
                { desde: 90000, hasta: 120000, tipo: 23.5 },
                { desde: 120000, hasta: 175000, tipo: 24.5 },
                { desde: 175000, hasta: 300000, tipo: 25.5 },
                { desde: 300000, hasta: Infinity, tipo: 25.5 }
            ],
            default: [
                { desde: 0, hasta: 12450, tipo: 9.5 },
                { desde: 12450, hasta: 20200, tipo: 12 },
                { desde: 20200, hasta: 35200, tipo: 15 },
                { desde: 35200, hasta: 60000, tipo: 18.5 },
                { desde: 60000, hasta: 300000, tipo: 22.5 },
                { desde: 300000, hasta: Infinity, tipo: 22.5 }
            ]
        };

        const minimoPersonal = 5550;
        const minimoPersonalMayor65 = 6700;
        const minimoPersonalMayor75 = 8100;
        const minimoPorHijo = { primero: 2400, segundo: 2700, tercero: 4000, resto: 4500 };
        const gastosDduciblesTrabajo = 2000;
        const maxPlanPensiones = 1500;

        let datosDeclaracion = {};
        let resultadosCalculados = {};
        let exerciseYear = 2024;

        function changeYear() {
            exerciseYear = parseInt(document.getElementById('exerciseYear').value);
            
            // Actualizar t√≠tulos din√°micos
            document.getElementById('mainTitle').textContent = `üá™üá∏ Declaraci√≥n de la Renta ${exerciseYear}`;
            document.getElementById('ingresosTitle').textContent = `Ingresos del Ejercicio ${exerciseYear}`;
            
            // Actualizar descripci√≥n con a√±o de campa√±a
            const nextYear = exerciseYear + 1;
            document.getElementById('headerDescription').textContent = 
                `Herramienta avanzada para el c√°lculo de IRPF ${exerciseYear} - Totalmente offline con PDFs reales`;
            
            // Actualizar base legal
            const legalBaseElement = document.getElementById('legalBase');
            if (legalBaseElement) {
                legalBaseElement.textContent = `C√°lculos seg√∫n Ley 35/2006 del IRPF, RD 439/2007 y normativa auton√≥mica ${exerciseYear}.`;
            }
            
            // Actualizar fechas importantes
            updateImportantDates();
            
            // Recalcular con los datos del nuevo a√±o
            calculate();
            
            console.log(`üìÖ Cambiado a ejercicio fiscal ${exerciseYear}`);
        }

        function updateImportantDates() {
            const campaignYear = exerciseYear + 1;
            const importantDatesElement = document.querySelector('.info-card:nth-last-child(2) p');
            if (importantDatesElement) {
                importantDatesElement.innerHTML = `
                    <strong>Inicio campa√±a:</strong> 3 de abril ${campaignYear}<br>
                    <strong>Fin campa√±a:</strong> 1 de julio ${campaignYear}<br>
                    <strong>Cita previa:</strong> 2 de mayo ${campaignYear}<br>
                    <strong>L√≠mite domiciliaci√≥n:</strong> 25 de junio ${campaignYear}
                `;
            }
        }

        function validateNIF() {
            const nif = document.getElementById('nif').value.toUpperCase();
            const nifRegex = /^[0-9]{8}[TRWAGMYFPDXBNJZSQVHLCKE]$/;
            const nieRegex = /^[XYZ][0-9]{7}[TRWAGMYFPDXBNJZSQVHLCKE]$/;
            
            if (nif && !nifRegex.test(nif) && !nieRegex.test(nif)) {
                document.getElementById('nif').classList.add('validation-error');
                alert('NIF/NIE no v√°lido');
            } else {
                document.getElementById('nif').classList.remove('validation-error');
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            const tabs = ['personal', 'ingresos', 'deducciones', 'optimizacion', 'resultado'];
            const currentIndex = tabs.indexOf(tabName);
            const progress = ((currentIndex + 1) / tabs.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            if (tabName === 'optimizacion') {
                calcularOptimizaciones();
            }
        }

        function recogerDatos() {
            datosDeclaracion = {
                exerciseYear: exerciseYear,
                nif: document.getElementById('nif').value,
                nombre: document.getElementById('nombre').value,
                edad: parseInt(document.getElementById('edad').value) || 0,
                estadoCivil: document.getElementById('estadoCivil').value,
                hijos: parseInt(document.getElementById('hijos').value) || 0,
                discapacidad: parseInt(document.getElementById('discapacidad').value) || 0,
                comunidad: document.getElementById('comunidad').value,
                mayor65: document.getElementById('mayor65').checked,
                mayor75: document.getElementById('mayor75').checked,
                sueldos: parseFloat(document.getElementById('sueldos').value) || 0,
                pensiones: parseFloat(document.getElementById('pensiones').value) || 0,
                pensionesPrivadas: parseFloat(document.getElementById('pensionesPrivadas').value) || 0,
                alquiler: parseFloat(document.getElementById('alquiler').value) || 0,
                capital: parseFloat(document.getElementById('capital').value) || 0,
                intereses: parseFloat(document.getElementById('intereses').value) || 0,
                actividades: parseFloat(document.getElementById('actividades').value) || 0,
                ganancias: parseFloat(document.getElementById('ganancias').value) || 0,
                subvenciones: parseFloat(document.getElementById('subvenciones').value) || 0,
                retenido: parseFloat(document.getElementById('retenido').value) || 0,
                vivienda: parseFloat(document.getElementById('vivienda').value) || 0,
                donativos: parseFloat(document.getElementById('donativos').value) || 0,
                partidosPoliticos: parseFloat(document.getElementById('partidosPoliticos').value) || 0,
                planPensiones: Math.min(parseFloat(document.getElementById('planPensiones').value) || 0, maxPlanPensiones),
                mutualidad: parseFloat(document.getElementById('mutualidad').value) || 0,
                pias: parseFloat(document.getElementById('pias').value) || 0,
                guarderia: parseFloat(document.getElementById('guarderia').value) || 0,
                textosEscolares: parseFloat(document.getElementById('textosEscolares').value) || 0,
                seguroMedico: parseFloat(document.getElementById('seguroMedico').value) || 0,
                rehabilitacion: parseFloat(document.getElementById('rehabilitacion').value) || 0
            };
        }

        function calculate() {
            recogerDatos();

            // Calcular totales
            const totalIngresos = datosDeclaracion.sueldos + datosDeclaracion.pensiones + 
                                datosDeclaracion.pensionesPrivadas + datosDeclaracion.alquiler + 
                                datosDeclaracion.capital + datosDeclaracion.intereses +
                                datosDeclaracion.actividades + datosDeclaracion.ganancias +
                                datosDeclaracion.subvenciones;

            // Calcular gastos deducibles del trabajo
            const gastosDeducibles = Math.min(gastosDduciblesTrabajo, datosDeclaracion.sueldos * 0.05);

            // Calcular base imponible
            const baseImponible = Math.max(0, totalIngresos - gastosDeducibles);

            // Calcular m√≠nimo por descendientes
            let minimoDescendientes = 0;
            for (let i = 0; i < datosDeclaracion.hijos; i++) {
                if (i === 0) minimoDescendientes += minimoPorHijo.primero;
                else if (i === 1) minimoDescendientes += minimoPorHijo.segundo;
                else if (i === 2) minimoDescendientes += minimoPorHijo.tercero;
                else minimoDescendientes += minimoPorHijo.resto;
            }

            // Calcular m√≠nimo personal seg√∫n edad
            let minimoPersonalAplicable = minimoPersonal;
            if (datosDeclaracion.mayor75) minimoPersonalAplicable = minimoPersonalMayor75;
            else if (datosDeclaracion.mayor65) minimoPersonalAplicable = minimoPersonalMayor65;

            // Calcular reducciones
            const reducciones = datosDeclaracion.planPensiones + datosDeclaracion.mutualidad + datosDeclaracion.pias;

            // Calcular base liquidable
            const baseLiquidable = Math.max(0, baseImponible - reducciones);

            // Calcular cuota √≠ntegra estatal
            const cuotaIntegra = calcularCuotaPorTramos(baseLiquidable, tramosIRPFEstatal);

            // Calcular cuota √≠ntegra auton√≥mica
            const tramosAutonomicos = tramosIRPFAutonomico[datosDeclaracion.comunidad] || tramosIRPFAutonomico.default;
            const cuotaAutonomica = calcularCuotaPorTramos(baseLiquidable, tramosAutonomicos);

            // Calcular m√≠nimo personal y familiar
            const minimoPersonalTotal = minimoPersonalAplicable + minimoDescendientes;
            const cuotaMinimo = calcularCuotaPorTramos(minimoPersonalTotal, tramosIRPFEstatal) + 
                              calcularCuotaPorTramos(minimoPersonalTotal, tramosAutonomicos);

            // Aplicar m√≠nimo personal y familiar
            const cuotaTotalIntegra = Math.max(0, cuotaIntegra + cuotaAutonomica - cuotaMinimo);

            // Calcular deducciones estatales
            let deduccionesEstatales = datosDeclaracion.vivienda;
            
            // Deducci√≥n por donativos
            if (datosDeclaracion.donativos > 0) {
                if (datosDeclaracion.donativos <= 150) {
                    deduccionesEstatales += datosDeclaracion.donativos * 0.75;
                } else {
                    deduccionesEstatales += 150 * 0.75 + (datosDeclaracion.donativos - 150) * 0.30;
                }
            }

            // Deducci√≥n por partidos pol√≠ticos
            deduccionesEstatales += Math.min(datosDeclaracion.partidosPoliticos * 0.20, 600);

            // Calcular deducciones auton√≥micas (simplificado)
            const deduccionesAutonomicas = calcularDeduccionesAutonomicas();

            // Calcular cuota l√≠quida
            const cuotaLiquida = Math.max(0, cuotaTotalIntegra - deduccionesEstatales - deduccionesAutonomicas);

            // Calcular resultado final
            const resultadoFinal = cuotaLiquida - datosDeclaracion.retenido;

            // Guardar resultados
            resultadosCalculados = {
                totalIngresos,
                baseImponible,
                baseLiquidable,
                cuotaIntegra,
                cuotaAutonomica,
                cuotaLiquida,
                resultadoFinal,
                gastosDeducibles,
                minimoPersonalAplicable,
                minimoDescendientes,
                deduccionesEstatales,
                deduccionesAutonomicas
            };

            // Actualizar interfaz
            actualizarInterfaz();
        }

        function calcularCuotaPorTramos(base, tramos) {
            let cuota = 0;
            for (const tramo of tramos) {
                if (base > tramo.desde) {
                    const baseTramo = Math.min(base, tramo.hasta) - tramo.desde;
                    cuota += baseTramo * tramo.tipo / 100;
                }
            }
            return cuota;
        }

        function calcularDeduccionesAutonomicas() {
            let deducciones = 0;
            
            // Deducciones comunes simplificadas
            if (datosDeclaracion.hijos > 0) {
                deducciones += datosDeclaracion.guarderia * 0.15; // 15% gastos guarder√≠a
                deducciones += Math.min(datosDeclaracion.textosEscolares * 0.10, 100); // 10% libros, m√°x 100‚Ç¨
            }
            
            deducciones += Math.min(datosDeclaracion.seguroMedico * 0.10, 500); // 10% seguro m√©dico, m√°x 500‚Ç¨
            deducciones += Math.min(datosDeclaracion.rehabilitacion * 0.20, 9000); // 20% rehabilitaci√≥n, m√°x 9000‚Ç¨
            
            return deducciones;
        }

        function actualizarInterfaz() {
            const r = resultadosCalculados;
            
            document.getElementById('totalIngresos').textContent = r.totalIngresos.toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('irpfCalculado').textContent = r.cuotaLiquida.toFixed(0) + ' ‚Ç¨';
            document.getElementById('resultadoFinal').textContent = Math.abs(r.resultadoFinal).toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('resultadoTipo').textContent = r.resultadoFinal > 0 ? 'A ingresar' : 'A devolver';
            
            document.getElementById('baseImponible').textContent = r.baseImponible.toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('baseLiquidable').textContent = r.baseLiquidable.toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('cuotaIntegra').textContent = r.cuotaIntegra.toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('cuotaAutonomica').textContent = r.cuotaAutonomica.toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('cuotaLiquida').textContent = r.cuotaLiquida.toLocaleString('es-ES') + ' ‚Ç¨';
            
            document.getElementById('minimoPersonal').textContent = r.minimoPersonalAplicable.toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('minimoDescendientes').textContent = r.minimoDescendientes.toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('gastosDeducibles').textContent = r.gastosDeducibles.toLocaleString('es-ES') + ' ‚Ç¨';
            
            // Actualizar desglose de tramos
            actualizarDesgloseTramos();
            
            // Actualizar alert del resultado
            const alertEl = document.getElementById('resultadoAlert');
            if (r.resultadoFinal > 0) {
                alertEl.textContent = `Resultado: ${r.resultadoFinal.toLocaleString('es-ES')} ‚Ç¨ a ingresar`;
                alertEl.className = 'alert warning';
            } else {
                alertEl.textContent = `Resultado: ${Math.abs(r.resultadoFinal).toLocaleString('es-ES')} ‚Ç¨ a devolver`;
                alertEl.className = 'alert';
            }

            // Actualizar consejos fiscales
            updateConsejos();
        }

        function actualizarDesgloseTramos() {
            let taxBracketsHtml = '<strong>Estatal:</strong><br>';
            
            for (const tramo of tramosIRPFEstatal) {
                if (resultadosCalculados.baseLiquidable > tramo.desde) {
                    const baseTramo = Math.min(resultadosCalculados.baseLiquidable, tramo.hasta) - tramo.desde;
                    const cuotaTramo = baseTramo * tramo.tipo / 100;
                    
                    if (baseTramo > 0) {
                        taxBracketsHtml += `<div class="tax-bracket">
                            <span>${tramo.tipo}%</span>
                            <span>${cuotaTramo.toFixed(0)}‚Ç¨</span>
                        </div>`;
                    }
                }
            }
            
            taxBracketsHtml += '<br><strong>Auton√≥mico:</strong><br>';
            const tramosAutonomicos = tramosIRPFAutonomico[datosDeclaracion.comunidad] || tramosIRPFAutonomico.default;
            
            for (const tramo of tramosAutonomicos) {
                if (resultadosCalculados.baseLiquidable > tramo.desde) {
                    const baseTramo = Math.min(resultadosCalculados.baseLiquidable, tramo.hasta) - tramo.desde;
                    const cuotaTramo = baseTramo * tramo.tipo / 100;
                    
                    if (baseTramo > 0) {
                        taxBracketsHtml += `<div class="tax-bracket">
                            <span>${tramo.tipo}%</span>
                            <span>${cuotaTramo.toFixed(0)}‚Ç¨</span>
                        </div>`;
                    }
                }
            }

            document.getElementById('taxBrackets').innerHTML = taxBracketsHtml;
        }

        function updateConsejos() {
            const consejos = document.getElementById('consejosFiscales');
            let consejo = '';

            if (datosDeclaracion.planPensiones < maxPlanPensiones) {
                const pendiente = maxPlanPensiones - datosDeclaracion.planPensiones;
                const ahorro = pendiente * 0.47; // M√°ximo tramo marginal
                consejo = `üí∞ Puedes aportar ${pendiente.toLocaleString('es-ES')}‚Ç¨ m√°s a tu plan de pensiones y ahorrar hasta ${ahorro.toFixed(0)}‚Ç¨.`;
            } else if (datosDeclaracion.donativos === 0) {
                consejo = '‚ù§Ô∏è Las donaciones a ONG tienen una deducci√≥n del 75% los primeros 150‚Ç¨ (ahorro de 112,50‚Ç¨).';
            } else if (datosDeclaracion.hijos > 0 && datosDeclaracion.guarderia === 0) {
                consejo = 'üë∂ Si tienes gastos de guarder√≠a, puedes deducir un 15% en muchas comunidades aut√≥nomas.';
            } else {
                consejo = '‚úÖ Tu declaraci√≥n est√° optimizada fiscalmente seg√∫n los datos introducidos.';
            }

            consejos.innerHTML = consejo;
        }

        function calcularOptimizaciones() {
            let optimizaciones = [];
            let ahorroTotal = 0;

            // Optimizaci√≥n plan de pensiones
            if (datosDeclaracion.planPensiones < maxPlanPensiones) {
                const pendiente = maxPlanPensiones - datosDeclaracion.planPensiones;
                const ahorroEstimado = pendiente * 0.30; // Tramo medio estimado
                optimizaciones.push({
                    titulo: 'Plan de Pensiones',
                    descripcion: `Aportar ${pendiente.toLocaleString('es-ES')}‚Ç¨ m√°s`,
                    ahorro: ahorroEstimado
                });
                ahorroTotal += ahorroEstimado;
            }

            // Optimizaci√≥n donativos
            if (datosDeclaracion.donativos < 150) {
                const pendiente = 150 - datosDeclaracion.donativos;
                const ahorro = pendiente * 0.75;
                optimizaciones.push({
                    titulo: 'Donativos ONG',
                    descripcion: `Donar ${pendiente.toLocaleString('es-ES')}‚Ç¨ m√°s`,
                    ahorro: ahorro
                });
                ahorroTotal += ahorro;
            }

            // Mostrar resultados
            let html = '';
            optimizaciones.forEach(opt => {
                html += `
                    <div class="info-card">
                        <h4>${opt.titulo}</h4>
                        <p>${opt.descripcion}</p>
                        <p><strong>Ahorro fiscal: ${opt.ahorro.toFixed(2)}‚Ç¨</strong></p>
                    </div>
                `;
            });

            if (optimizaciones.length === 0) {
                html = '<div class="alert">üéâ Tu declaraci√≥n ya est√° optimizada al m√°ximo con los datos actuales.</div>';
            }

            document.getElementById('optimizationResults').innerHTML = html;
            document.getElementById('ahorroTotal').textContent = ahorroTotal.toFixed(0) + ' ‚Ç¨';

            // Generar recomendaciones
            generarRecomendaciones();
        }

        function generarRecomendaciones() {
            let recomendaciones = [];

            if (datosDeclaracion.hijos > 0) {
                recomendaciones.push('üë∂ Guarda facturas de gastos relacionados con tus hijos (guarder√≠a, libros, actividades extraescolares)');
            }

            if (datosDeclaracion.alquiler > 0) {
                recomendaciones.push('üè† Deduce gastos de mantenimiento, seguros e IBI de tu inmueble alquilado');
            }

            if (datosDeclaracion.sueldos > 30000) {
                recomendaciones.push('üíº Considera aumentar tus aportaciones a planes de pensiones para el pr√≥ximo a√±o');
            }

            const html = recomendaciones.map(rec => `<p>‚Ä¢ ${rec}</p>`).join('');
            document.getElementById('recommendations').innerHTML = html || '<p>‚Ä¢ Mant√©n todas las facturas organizadas para futuras declaraciones</p>';
        }

        // FUNCIONES DEL SIMULADOR
        function simularEscenarios() {
            // Mostrar el modal de simulaci√≥n
            const modal = document.getElementById('simulationModal');
            modal.style.display = 'block';
            
            // Inicializar valores del simulador con datos actuales
            document.getElementById('simPlanPensiones').value = datosDeclaracion.planPensiones;
            document.getElementById('simDonativos').value = datosDeclaracion.donativos;
            document.getElementById('simGuarderia').value = datosDeclaracion.guarderia;
            document.getElementById('simSeguroMedico').value = datosDeclaracion.seguroMedico;
            document.getElementById('simSueldo').value = datosDeclaracion.sueldos;
            document.getElementById('simComunidad').value = datosDeclaracion.comunidad;
            
            // Mostrar resultados actuales
            updateSimulationResults();
        }

        function syncSlider(inputId, value) {
            document.getElementById(inputId).value = value;
            document.getElementById(inputId + 'Range').value = value;
        }

        function updateSimulationResults() {
            // Obtener valores simulados
            const datosSimulados = {
                ...datosDeclaracion,
                sueldos: parseFloat(document.getElementById('simSueldo').value) || 0,
                planPensiones: Math.min(parseFloat(document.getElementById('simPlanPensiones').value) || 0, 1500),
                donativos: parseFloat(document.getElementById('simDonativos').value) || 0,
                guarderia: parseFloat(document.getElementById('simGuarderia').value) || 0,
                seguroMedico: parseFloat(document.getElementById('simSeguroMedico').value) || 0,
                comunidad: document.getElementById('simComunidad').value
            };
            
            // Sincronizar sliders
            document.getElementById('simSueldoRange').value = datosSimulados.sueldos;
            document.getElementById('simPlanPensionesRange').value = datosSimulados.planPensiones;
            document.getElementById('simDonativosRange').value = datosSimulados.donativos;
            document.getElementById('simGuarderiaRange').value = datosSimulados.guarderia;
            document.getElementById('simSeguroMedicoRange').value = datosSimulados.seguroMedico;
            
            // Calcular escenario simulado
            const resultadoSimulado = calcularEscenario(datosSimulados);
            
            // Mostrar resultados actuales
            document.getElementById('resultadoActualSim').textContent = Math.abs(resultadosCalculados.resultadoFinal).toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('tipoActualSim').textContent = resultadosCalculados.resultadoFinal > 0 ? 'A ingresar' : 'A devolver';
            
            // Mostrar resultados simulados
            document.getElementById('resultadoSimulado').textContent = Math.abs(resultadoSimulado.resultadoFinal).toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('tipoSimulado').textContent = resultadoSimulado.resultadoFinal > 0 ? 'A ingresar' : 'A devolver';
            
            // Calcular diferencia
            const diferencia = resultadosCalculados.resultadoFinal - resultadoSimulado.resultadoFinal;
            document.getElementById('diferenciaSim').textContent = Math.abs(diferencia).toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('tipoDiferencia').textContent = diferencia > 0 ? 'Ahorro' : 'Coste adicional';
            
            // Mostrar cambios detallados
            mostrarCambiosDetallados(resultadosCalculados, resultadoSimulado, datosDeclaracion, datosSimulados);
            
            // Generar recomendaciones
            generarRecomendacionesSimulacion(datosSimulados, diferencia);
        }

        function calcularEscenario(datos) {
            // Calcular totales
            const totalIngresos = datos.sueldos + datos.pensiones + datos.pensionesPrivadas + 
                                datos.alquiler + datos.capital + datos.intereses +
                                datos.actividades + datos.ganancias + datos.subvenciones;

            // Calcular gastos deducibles del trabajo
            const gastosDeducibles = Math.min(gastosDduciblesTrabajo, datos.sueldos * 0.05);

            // Calcular base imponible
            const baseImponible = Math.max(0, totalIngresos - gastosDeducibles);

            // Calcular m√≠nimo por descendientes
            let minimoDescendientes = 0;
            for (let i = 0; i < datos.hijos; i++) {
                if (i === 0) minimoDescendientes += minimoPorHijo.primero;
                else if (i === 1) minimoDescendientes += minimoPorHijo.segundo;
                else if (i === 2) minimoDescendientes += minimoPorHijo.tercero;
                else minimoDescendientes += minimoPorHijo.resto;
            }

            // Calcular m√≠nimo personal seg√∫n edad
            let minimoPersonalAplicable = minimoPersonal;
            if (datos.mayor75) minimoPersonalAplicable = minimoPersonalMayor75;
            else if (datos.mayor65) minimoPersonalAplicable = minimoPersonalMayor65;

            // Calcular reducciones
            const reducciones = datos.planPensiones + datos.mutualidad + datos.pias;

            // Calcular base liquidable
            const baseLiquidable = Math.max(0, baseImponible - reducciones);

            // Calcular cuota √≠ntegra estatal
            const cuotaIntegra = calcularCuotaPorTramos(baseLiquidable, tramosIRPFEstatal);

            // Calcular cuota √≠ntegra auton√≥mica
            const tramosAutonomicos = tramosIRPFAutonomico[datos.comunidad] || tramosIRPFAutonomico.default;
            const cuotaAutonomica = calcularCuotaPorTramos(baseLiquidable, tramosAutonomicos);

            // Calcular m√≠nimo personal y familiar
            const minimoPersonalTotal = minimoPersonalAplicable + minimoDescendientes;
            const cuotaMinimo = calcularCuotaPorTramos(minimoPersonalTotal, tramosIRPFEstatal) + 
                              calcularCuotaPorTramos(minimoPersonalTotal, tramosAutonomicos);

            // Aplicar m√≠nimo personal y familiar
            const cuotaTotalIntegra = Math.max(0, cuotaIntegra + cuotaAutonomica - cuotaMinimo);

            // Calcular deducciones estatales
            let deduccionesEstatales = datos.vivienda;
            
            // Deducci√≥n por donativos
            if (datos.donativos > 0) {
                if (datos.donativos <= 150) {
                    deduccionesEstatales += datos.donativos * 0.75;
                } else {
                    deduccionesEstatales += 150 * 0.75 + (datos.donativos - 150) * 0.30;
                }
            }

            // Deducci√≥n por partidos pol√≠ticos
            deduccionesEstatales += Math.min(datos.partidosPoliticos * 0.20, 600);

            // Calcular deducciones auton√≥micas
            let deduccionesAutonomicas = 0;
            if (datos.hijos > 0) {
                deduccionesAutonomicas += datos.guarderia * 0.15;
                deduccionesAutonomicas += Math.min(datos.textosEscolares * 0.10, 100);
            }
            deduccionesAutonomicas += Math.min(datos.seguroMedico * 0.10, 500);
            deduccionesAutonomicas += Math.min(datos.rehabilitacion * 0.20, 9000);

            // Calcular cuota l√≠quida
            const cuotaLiquida = Math.max(0, cuotaTotalIntegra - deduccionesEstatales - deduccionesAutonomicas);

            // Calcular resultado final
            const resultadoFinal = cuotaLiquida - datos.retenido;

            return {
                totalIngresos,
                baseImponible,
                baseLiquidable,
                cuotaIntegra,
                cuotaAutonomica,
                cuotaLiquida,
                resultadoFinal,
                deduccionesEstatales,
                deduccionesAutonomicas
            };
        }

        function mostrarCambiosDetallados(actual, simulado, datosActuales, datosSimulados) {
            let cambios = [];
            
            if (datosActuales.sueldos !== datosSimulados.sueldos) {
                const diff = datosSimulados.sueldos - datosActuales.sueldos;
                cambios.push(`Sueldo: ${diff > 0 ? '+' : ''}${diff.toLocaleString('es-ES')} ‚Ç¨`);
            }
            
            if (datosActuales.planPensiones !== datosSimulados.planPensiones) {
                const diff = datosSimulados.planPensiones - datosActuales.planPensiones;
                cambios.push(`Plan pensiones: ${diff > 0 ? '+' : ''}${diff.toLocaleString('es-ES')} ‚Ç¨`);
            }
            
            if (datosActuales.donativos !== datosSimulados.donativos) {
                const diff = datosSimulados.donativos - datosActuales.donativos;
                cambios.push(`Donativos: ${diff > 0 ? '+' : ''}${diff.toLocaleString('es-ES')} ‚Ç¨`);
            }
            
            if (datosActuales.guarderia !== datosSimulados.guarderia) {
                const diff = datosSimulados.guarderia - datosActuales.guarderia;
                cambios.push(`Guarder√≠a: ${diff > 0 ? '+' : ''}${diff.toLocaleString('es-ES')} ‚Ç¨`);
            }
            
            if (datosActuales.seguroMedico !== datosSimulados.seguroMedico) {
                const diff = datosSimulados.seguroMedico - datosActuales.seguroMedico;
                cambios.push(`Seguro m√©dico: ${diff > 0 ? '+' : ''}${diff.toLocaleString('es-ES')} ‚Ç¨`);
            }
            
            if (datosActuales.comunidad !== datosSimulados.comunidad) {
                cambios.push(`Comunidad: ${datosActuales.comunidad} ‚Üí ${datosSimulados.comunidad}`);
            }
            
            const cambiosHtml = cambios.length > 0 ? 
                cambios.map(c => `<div style="margin-bottom: 5px;">‚Ä¢ ${c}</div>`).join('') :
                '<div style="color: #7f8c8d;">Sin cambios</div>';
            
            document.getElementById('cambiosDetallados').innerHTML = cambiosHtml;
        }

        function generarRecomendacionesSimulacion(datos, diferencia) {
            let recomendaciones = [];
            
            if (datos.planPensiones < 1500) {
                const pendiente = 1500 - datos.planPensiones;
                const ahorroEstimado = pendiente * 0.30;
                recomendaciones.push(`Aumenta ${pendiente}‚Ç¨ en plan de pensiones para ahorrar ~${ahorroEstimado.toFixed(0)}‚Ç¨`);
            }
            
            if (datos.donativos < 150) {
                const pendiente = 150 - datos.donativos;
                const ahorro = pendiente * 0.75;
                recomendaciones.push(`Dona ${pendiente}‚Ç¨ m√°s para ahorrar ${ahorro.toFixed(0)}‚Ç¨ (75% deducible)`);
            }
            
            if (datos.hijos > 0 && datos.guarderia < 2000) {
                recomendaciones.push('Si tienes gastos de guarder√≠a, aseg√∫rate de incluirlos todos');
            }
            
            if (diferencia > 500) {
                recomendaciones.push('üéâ Esta optimizaci√≥n te ahorrar√≠a m√°s de 500‚Ç¨');
            } else if (diferencia > 100) {
                recomendaciones.push('‚úÖ Optimizaci√≥n con ahorro moderado pero recomendable');
            }
            
            const recomendacionesHtml = recomendaciones.length > 0 ?
                recomendaciones.map(r => `<div style="margin-bottom: 8px;">‚Ä¢ ${r}</div>`).join('') :
                '<div>‚Ä¢ Contin√∫a explorando diferentes combinaciones</div>';
            
            document.getElementById('recomendacionesSimulacion').innerHTML = recomendacionesHtml;
        }

        function aplicarOptimizaciones() {
            if (confirm('¬øAplicar estas optimizaciones a tu declaraci√≥n actual?')) {
                // Aplicar valores simulados a los campos reales
                document.getElementById('sueldos').value = document.getElementById('simSueldo').value;
                document.getElementById('planPensiones').value = document.getElementById('simPlanPensiones').value;
                document.getElementById('donativos').value = document.getElementById('simDonativos').value;
                document.getElementById('guarderia').value = document.getElementById('simGuarderia').value;
                document.getElementById('seguroMedico').value = document.getElementById('simSeguroMedico').value;
                document.getElementById('comunidad').value = document.getElementById('simComunidad').value;
                
                // Recalcular declaraci√≥n principal
                calculate();
                
                // Cerrar modal
                closeSimulationModal();
                
                alert('‚úÖ Optimizaciones aplicadas correctamente.\n\nTu declaraci√≥n ha sido actualizada con los nuevos valores.');
            }
        }

        function resetearSimulacion() {
            // Restaurar valores originales
            document.getElementById('simSueldo').value = datosDeclaracion.sueldos;
            document.getElementById('simPlanPensiones').value = datosDeclaracion.planPensiones;
            document.getElementById('simDonativos').value = datosDeclaracion.donativos;
            document.getElementById('simGuarderia').value = datosDeclaracion.guarderia;
            document.getElementById('simSeguroMedico').value = datosDeclaracion.seguroMedico;
            document.getElementById('simComunidad').value = datosDeclaracion.comunidad;
            
            updateSimulationResults();
        }

        function closeSimulationModal() {
            document.getElementById('simulationModal').style.display = 'none';
        }

        // Cerrar modal al hacer clic fuera de √©l
        window.onclick = function(event) {
            const modal = document.getElementById('simulationModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        function generarInforme() {
            if (!resultadosCalculados.totalIngresos) {
                alert('‚ö†Ô∏è Primero debes completar los datos y calcular la declaraci√≥n');
                return;
            }

            document.getElementById('loadingPDF').style.display = 'block';

            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // Configuraci√≥n del documento
                    doc.setFontSize(20);
                    doc.setFont(undefined, 'bold');
                    doc.text(`DECLARACI√ìN DE LA RENTA ${exerciseYear}`, 20, 20);
                    doc.text('INFORME DETALLADO', 20, 30);

                    // Datos personales
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('DATOS PERSONALES', 20, 50);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`NIF/NIE: ${datosDeclaracion.nif || 'No especificado'}`, 20, 60);
                    doc.text(`Nombre: ${datosDeclaracion.nombre || 'No especificado'}`, 20, 70);
                    doc.text(`Edad: ${datosDeclaracion.edad} a√±os`, 20, 80);
                    doc.text(`Estado Civil: ${datosDeclaracion.estadoCivil}`, 20, 90);
                    doc.text(`Hijos: ${datosDeclaracion.hijos}`, 20, 100);
                    doc.text(`Comunidad Aut√≥noma: ${datosDeclaracion.comunidad}`, 20, 110);

                    // Resumen de ingresos
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('RESUMEN DE INGRESOS', 20, 130);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    let y = 140;
                    
                    if (datosDeclaracion.sueldos > 0) {
                        doc.text(`Rendimientos del trabajo: ${datosDeclaracion.sueldos.toLocaleString('es-ES')} ‚Ç¨`, 20, y);
                        y += 10;
                    }
                    if (datosDeclaracion.pensiones > 0) {
                        doc.text(`Pensiones p√∫blicas: ${datosDeclaracion.pensiones.toLocaleString('es-ES')} ‚Ç¨`, 20, y);
                        y += 10;
                    }
                    if (datosDeclaracion.alquiler > 0) {
                        doc.text(`Rendimientos inmobiliarios: ${datosDeclaracion.alquiler.toLocaleString('es-ES')} ‚Ç¨`, 20, y);
                        y += 10;
                    }
                    if (datosDeclaracion.capital > 0) {
                        doc.text(`Rendimientos del capital: ${datosDeclaracion.capital.toLocaleString('es-ES')} ‚Ç¨`, 20, y);
                        y += 10;
                    }
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`TOTAL INGRESOS: ${resultadosCalculados.totalIngresos.toLocaleString('es-ES')} ‚Ç¨`, 20, y + 10);

                    // C√°lculos fiscales
                    y += 30;
                    doc.setFontSize(14);
                    doc.text('C√ÅLCULOS FISCALES', 20, y);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    y += 10;
                    
                    doc.text(`Base imponible: ${resultadosCalculados.baseImponible.toLocaleString('es-ES')} ‚Ç¨`, 20, y);
                    y += 10;
                    doc.text(`Base liquidable: ${resultadosCalculados.baseLiquidable.toLocaleString('es-ES')} ‚Ç¨`, 20, y);
                    y += 10;
                    doc.text(`Cuota √≠ntegra estatal: ${resultadosCalculados.cuotaIntegra.toLocaleString('es-ES')} ‚Ç¨`, 20, y);
                    y += 10;
                    doc.text(`Cuota √≠ntegra auton√≥mica: ${resultadosCalculados.cuotaAutonomica.toLocaleString('es-ES')} ‚Ç¨`, 20, y);
                    y += 10;
                    doc.text(`Deducciones aplicadas: ${(resultadosCalculados.deduccionesEstatales + resultadosCalculados.deduccionesAutonomicas).toLocaleString('es-ES')} ‚Ç¨`, 20, y);
                    y += 10;
                    doc.text(`Cuota l√≠quida: ${resultadosCalculados.cuotaLiquida.toLocaleString('es-ES')} ‚Ç¨`, 20, y);
                    y += 10;
                    doc.text(`IRPF retenido: ${datosDeclaracion.retenido.toLocaleString('es-ES')} ‚Ç¨`, 20, y);

                    // Resultado final
                    y += 20;
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    if (resultadosCalculados.resultadoFinal > 0) {
                        doc.setTextColor(200, 0, 0);
                        doc.text(`RESULTADO: ${resultadosCalculados.resultadoFinal.toLocaleString('es-ES')} ‚Ç¨ A INGRESAR`, 20, y);
                    } else {
                        doc.setTextColor(0, 150, 0);
                        doc.text(`RESULTADO: ${Math.abs(resultadosCalculados.resultadoFinal).toLocaleString('es-ES')} ‚Ç¨ A DEVOLVER`, 20, y);
                    }

                    // Nueva p√°gina para tramos fiscales
                    doc.addPage();
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('DESGLOSE DE TRAMOS FISCALES', 20, 20);

                    // Tramos estatales
                    doc.setFontSize(12);
                    doc.text('TRAMOS ESTATALES', 20, 40);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    y = 50;
                    
                    for (const tramo of tramosIRPFEstatal) {
                        if (resultadosCalculados.baseLiquidable > tramo.desde) {
                            const baseTramo = Math.min(resultadosCalculados.baseLiquidable, tramo.hasta) - tramo.desde;
                            const cuotaTramo = baseTramo * tramo.tipo / 100;
                            
                            if (baseTramo > 0) {
                                doc.text(`${tramo.desde.toLocaleString('es-ES')} - ${tramo.hasta === Infinity ? '‚àû' : tramo.hasta.toLocaleString('es-ES')} ‚Ç¨: ${tramo.tipo}% = ${cuotaTramo.toFixed(2)} ‚Ç¨`, 20, y);
                                y += 10;
                            }
                        }
                    }

                    // Tramos auton√≥micos
                    y += 10;
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`TRAMOS AUTON√ìMICOS (${datosDeclaracion.comunidad.toUpperCase()})`, 20, y);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    y += 10;
                    
                    const tramosAutonomicos = tramosIRPFAutonomico[datosDeclaracion.comunidad] || tramosIRPFAutonomico.default;
                    for (const tramo of tramosAutonomicos) {
                        if (resultadosCalculados.baseLiquidable > tramo.desde) {
                            const baseTramo = Math.min(resultadosCalculados.baseLiquidable, tramo.hasta) - tramo.desde;
                            const cuotaTramo = baseTramo * tramo.tipo / 100;
                            
                            if (baseTramo > 0) {
                                doc.text(`${tramo.desde.toLocaleString('es-ES')} - ${tramo.hasta === Infinity ? '‚àû' : tramo.hasta.toLocaleString('es-ES')} ‚Ç¨: ${tramo.tipo}% = ${cuotaTramo.toFixed(2)} ‚Ç¨`, 20, y);
                                y += 10;
                            }
                        }
                    }

                    // Pie de p√°gina
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Documento generado autom√°ticamente por la Herramienta de Declaraci√≥n de la Renta ${exerciseYear}`, 20, 280);
                    doc.text(`Fecha de generaci√≥n: ${new Date().toLocaleDateString('es-ES')}`, 20, 285);
                    doc.text('Este documento es solo informativo. Para presentar la declaraci√≥n oficial utilice los canales de la AEAT.', 20, 290);

                    // Guardar el PDF
                    const fileName = `Declaracion_Renta_${exerciseYear}_${datosDeclaracion.nif || 'SinNIF'}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);

                    document.getElementById('loadingPDF').style.display = 'none';
                    alert('‚úÖ PDF generado correctamente y descargado.\n\nEl archivo incluye:\n‚Ä¢ Datos personales completos\n‚Ä¢ Resumen detallado de ingresos\n‚Ä¢ C√°lculos fiscales paso a paso\n‚Ä¢ Desglose de tramos fiscales\n‚Ä¢ Resultado final');

                } catch (error) {
                    document.getElementById('loadingPDF').style.display = 'none';
                    console.error('Error generando PDF:', error);
                    alert('‚ùå Error al generar el PDF. Verifica que todos los datos est√©n completos.');
                }
            }, 1000);
        }

        function guardarDatos() {
            try {
                const datosCompletos = {
                    exerciseYear,
                    datosDeclaracion,
                    resultadosCalculados,
                    fechaGuardado: new Date().toISOString()
                };
                
                const jsonString = JSON.stringify(datosCompletos, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `Borrador_Declaracion_${exerciseYear}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('üíæ Borrador guardado correctamente.\n\nPuedes cargar estos datos m√°s tarde usando el bot√≥n "Cargar Borrador".');
            } catch (error) {
                alert('‚ùå Error al guardar el borrador');
            }
        }

        function cargarDatos() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const datos = JSON.parse(e.target.result);
                        
                        if (datos.datosDeclaracion) {
                            // Restaurar a√±o si est√° disponible
                            if (datos.exerciseYear) {
                                exerciseYear = datos.exerciseYear;
                                document.getElementById('exerciseYear').value = exerciseYear;
                                changeYear(); // Actualizar interfaz con el nuevo a√±o
                            }
                            
                            // Cargar datos en el formulario
                            Object.keys(datos.datosDeclaracion).forEach(key => {
                                const element = document.getElementById(key);
                                if (element) {
                                    if (element.type === 'checkbox') {
                                        element.checked = datos.datosDeclaracion[key];
                                    } else {
                                        element.value = datos.datosDeclaracion[key];
                                    }
                                }
                            });
                            
                            // Recalcular
                            calculate();
                            
                            alert(`üìÇ Borrador del ejercicio ${exerciseYear} cargado correctamente.\n\nTodos los datos han sido restaurados y los c√°lculos actualizados.`);
                        } else {
                            alert('‚ùå Archivo no v√°lido');
                        }
                    } catch (error) {
                        alert('‚ùå Error al cargar el archivo');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function exportarExcel() {
            if (!resultadosCalculados.totalIngresos) {
                alert('‚ö†Ô∏è Primero debes completar los datos y calcular la declaraci√≥n');
                return;
            }

            // Crear contenido CSV (compatible con Excel)
            let csvContent = `DECLARACI√ìN DE LA RENTA ${exerciseYear} - RESUMEN\n\n`;
            
            csvContent += 'DATOS PERSONALES\n';
            csvContent += `Ejercicio Fiscal,${exerciseYear}\n`;
            csvContent += `NIF/NIE,${datosDeclaracion.nif || 'No especificado'}\n`;
            csvContent += `Nombre,${datosDeclaracion.nombre || 'No especificado'}\n`;
            csvContent += `Edad,${datosDeclaracion.edad}\n`;
            csvContent += `Estado Civil,${datosDeclaracion.estadoCivil}\n`;
            csvContent += `Hijos,${datosDeclaracion.hijos}\n`;
            csvContent += `Comunidad Aut√≥noma,${datosDeclaracion.comunidad}\n\n`;
            
            csvContent += 'INGRESOS\n';
            csvContent += `Rendimientos del trabajo,${datosDeclaracion.sueldos}\n`;
            csvContent += `Pensiones,${datosDeclaracion.pensiones}\n`;
            csvContent += `Rendimientos inmobiliarios,${datosDeclaracion.alquiler}\n`;
            csvContent += `Rendimientos del capital,${datosDeclaracion.capital}\n`;
            csvContent += `Total Ingresos,${resultadosCalculados.totalIngresos}\n\n`;
            
            csvContent += 'C√ÅLCULOS FISCALES\n';
            csvContent += `Base imponible,${resultadosCalculados.baseImponible}\n`;
            csvContent += `Base liquidable,${resultadosCalculados.baseLiquidable}\n`;
            csvContent += `Cuota √≠ntegra estatal,${resultadosCalculados.cuotaIntegra}\n`;
            csvContent += `Cuota √≠ntegra auton√≥mica,${resultadosCalculados.cuotaAutonomica}\n`;
            csvContent += `Cuota l√≠quida,${resultadosCalculados.cuotaLiquida}\n`;
            csvContent += `IRPF retenido,${datosDeclaracion.retenido}\n`;
            csvContent += `RESULTADO FINAL,${resultadosCalculados.resultadoFinal}\n`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `Declaracion_Renta_${exerciseYear}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('üìä Archivo Excel/CSV exportado correctamente.\n\nPuedes abrirlo con Excel, Google Sheets o cualquier hoja de c√°lculo.');
        }

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar a√±o inicial
            changeYear();
            
            // Cargar datos por defecto
            calculate();
            
            // Auto-guardar cada 30 segundos en el almacenamiento local del navegador
            setInterval(() => {
                if (datosDeclaracion.nif || datosDeclaracion.sueldos > 0) {
                    const datosAutoguardado = {
                        exerciseYear,
                        datosDeclaracion,
                        resultadosCalculados,
                        fechaAutoguardado: new Date().toISOString()
                    };
                    try {
                        const datosString = JSON.stringify(datosAutoguardado);
                        // Solo guardamos en memoria durante la sesi√≥n, no en localStorage
                        window.sessionData = datosString;
                    } catch (e) {
                        // Silenciar errores de autoguardado
                    }
                }
            }, 30000);

            console.log(`‚úÖ Aplicaci√≥n de Declaraci√≥n de la Renta ${exerciseYear} cargada correctamente`);
            console.log('üîß Funcionalidades disponibles:');
            console.log('‚Ä¢ Selector de a√±o fiscal (2024-2028)');
            console.log('‚Ä¢ C√°lculo completo de IRPF estatal y auton√≥mico');
            console.log('‚Ä¢ Generaci√≥n de PDF detallado');
            console.log('‚Ä¢ Exportaci√≥n a Excel/CSV');
            console.log('‚Ä¢ Guardado y carga de borradores');
            console.log('‚Ä¢ Optimizaci√≥n fiscal autom√°tica');
            console.log('‚Ä¢ Simulador interactivo de escenarios');
            console.log('‚Ä¢ Funciona completamente offline');
        });
    </script>
</body>
</html>
